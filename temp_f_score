import pandas as pd

# Make a copy so we don't mess the original
df_scores = df.copy()

# Assume lower scores = riskier â†’ sort ascending
df_scores = df_scores.sort_values('scores')

# Non-fraud indicator
df_scores['nonfraud'] = 1 - df_scores['fraud']

# Cumulative counts (moving from lowest score upward)
df_scores['cum_total'] = 1
df_scores['cum_total'] = df_scores['cum_total'].cumsum()

df_scores['cum_fraud'] = df_scores['fraud'].cumsum()
df_scores['cum_nonfraud'] = df_scores['nonfraud'].cumsum()

# Overall totals (for rates)
total_nonfraud = df_scores['nonfraud'].sum()
total_fraud = df_scores['fraud'].sum()

# Cumulative FPR & TPR at each row
df_scores['cum_fpr'] = df_scores['cum_nonfraud'] / total_nonfraud   # false positive rate
df_scores['cum_tpr'] = df_scores['cum_fraud'] / total_fraud         # true positive rate (recall)



cutoff_table = (
    df_scores[['scores', 'cum_total', 'cum_fraud', 'cum_nonfraud', 'cum_fpr', 'cum_tpr']]
    .drop_duplicates(subset='scores', keep='last')
    .rename(columns={
        'scores': 'score_cutoff',
        'cum_total': 'flagged_volume'
    })
    .reset_index(drop=True)
)

print(cutoff_table.head(20))


cutoff_table['cum_false_positives'] = cutoff_table['flagged_volume'] - cutoff_table['cum_fraud']


target_fpr = 0.05  # 5%

valid_cutoffs = cutoff_table[cutoff_table['cum_fpr'] <= target_fpr]

# Take the highest cutoff that respects the FPR constraint
best_cutoff_row = valid_cutoffs.tail(1)

print(best_cutoff_row)

df_scores = df.copy()
df_scores = df_scores.sort_values('scores', ascending=False)
