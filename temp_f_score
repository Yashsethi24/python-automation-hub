import pandas as pd

df_scores = df.copy()

# Assume lower scores = riskier; sort so we flag from highest-risk to lowest-risk
df_scores = df_scores.sort_values('scores')  # use ascending=False if higher = riskier

# Indicators
df_scores['nonfraud'] = 1 - df_scores['fraud']

# Amount of fraud and non-fraud per row
df_scores['fraud_amt'] = df_scores['CUR_BAL_TOT_SUM'] * df_scores['fraud']
df_scores['nonfraud_amt'] = df_scores['CUR_BAL_TOT_SUM'] * df_scores['nonfraud']

# Totals (for percentages)
total_fraud_cnt = df_scores['fraud'].sum()
total_fraud_amt = df_scores['fraud_amt'].sum()
total_nonfraud_cnt = df_scores['nonfraud'].sum()
total_nonfraud_amt = df_scores['nonfraud_amt'].sum()

# Cumulative counts
df_scores['cum_total'] = 1
df_scores['cum_total'] = df_scores['cum_total'].cumsum()

df_scores['cum_fraud_cnt'] = df_scores['fraud'].cumsum()
df_scores['cum_nonfraud_cnt'] = df_scores['nonfraud'].cumsum()

# Cumulative amounts
df_scores['cum_fraud_amt'] = df_scores['fraud_amt'].cumsum()
df_scores['cum_nonfraud_amt'] = df_scores['nonfraud_amt'].cumsum()

# Rates by count
df_scores['cum_fpr_cnt'] = df_scores['cum_nonfraud_cnt'] / total_nonfraud_cnt
df_scores['cum_tpr_cnt'] = df_scores['cum_fraud_cnt'] / total_fraud_cnt

# Rates by amount
df_scores['cum_fpr_amt'] = df_scores['cum_nonfraud_amt'] / total_nonfraud_amt
df_scores['cum_tpr_amt'] = df_scores['cum_fraud_amt'] / total_fraud_amt

cutoff_table = (
    df_scores[
        [
            'scores',
            'cum_total',
            'cum_fraud_cnt',
            'cum_nonfraud_cnt',
            'cum_fraud_amt',
            'cum_nonfraud_amt',
            'cum_fpr_cnt',
            'cum_tpr_cnt',
            'cum_fpr_amt',
            'cum_tpr_amt'
        ]
    ]
    .drop_duplicates(subset='scores', keep='last')
    .rename(columns={
        'scores': 'score_cutoff',
        'cum_total': 'flagged_volume',
        'cum_fraud_cnt': 'flagged_fraud_cnt',
        'cum_nonfraud_cnt': 'flagged_nonfraud_cnt',
        'cum_fraud_amt': 'flagged_fraud_amt',
        'cum_nonfraud_amt': 'flagged_nonfraud_amt',
        'cum_tpr_cnt': 'fraud_capture_rate_cnt',
        'cum_tpr_amt': 'fraud_capture_rate_amt'
    })
    .reset_index(drop=True)
)

print(cutoff_table.head(20))
