------------------------------------------------
-- SCENARIO GRID: months_back, fraud_cap, FPR
------------------------------------------------
IF OBJECT_ID('tempdb..#Scenarios') IS NOT NULL DROP TABLE #Scenarios;

;WITH Months AS (
    SELECT 1 AS months_back
    UNION ALL
    SELECT months_back + 1
    FROM Months
    WHERE months_back < 5             -- 1 to 5
),
FraudCaps AS (
    SELECT CAST(0 AS DECIMAL(18,2)) AS fraud_cap_amount
    UNION ALL
    SELECT fraud_cap_amount + 1000
    FROM FraudCaps
    WHERE fraud_cap_amount < 10000    -- 0, 1000, â€¦ 10000
),
Fprs AS (
    SELECT CAST(3.0 AS FLOAT) AS fpr_threshold
    UNION ALL
    SELECT fpr_threshold + 1.0
    FROM Fprs
    WHERE fpr_threshold < 6.0         -- 3, 4, 5, 6
)
SELECT
    ROW_NUMBER() OVER (ORDER BY m.months_back, f.fraud_cap_amount, p.fpr_threshold) AS scenario_id,
    m.months_back,
    f.fraud_cap_amount,
    p.fpr_threshold
INTO #Scenarios
FROM Months m
CROSS JOIN FraudCaps f
CROSS JOIN Fprs p
OPTION (MAXRECURSION 100);


SELECT * FROM #Scenarios ORDER BY scenario_id;


IF OBJECT_ID('tempdb..#ScenarioResults') IS NOT NULL DROP TABLE #ScenarioResults;

CREATE TABLE #ScenarioResults (
    scenario_id INT,
    months_back INT,
    fraud_cap_amount DECIMAL(18,2),
    fpr_threshold FLOAT,
    rule_name VARCHAR(200),
    unique_apps_agg INT,
    unique_fraud_amt_agg DECIMAL(18,2)
);


DECLARE @sql NVARCHAR(MAX);

SET @sql = N'
;WITH date_window AS (
    SELECT
        DATEADD(MONTH, -@months_back, CAST(GETDATE() AS DATE)) AS start_date,
        CAST(GETDATE() AS DATE) AS end_date
),
-- =======================
-- PUT YOUR REAL LOGIC HERE
-- Build all your CTEs (app_level, rule_app, rule_app_outcome, monthly_unique_stats...)
-- using @months_back, @fraud_cap_amount, @fpr_threshold in WHERE / HAVING
-- =======================
final_agg AS (
    -- Dummy example. REPLACE with your real aggregate per rule.
    -- Must output: rule_name, unique_apps_agg, unique_fraud_amt_agg
    SELECT
        rh.rule_name,
        COUNT(DISTINCT rh.app_id) AS unique_apps_agg,
        SUM(CASE WHEN o.fraud_ind = 1 THEN o.fraud_amount ELSE 0 END) AS unique_fraud_amt_agg
    FROM rule_hits rh
    JOIN app_outcomes o ON o.app_id = rh.app_id
    JOIN date_window dw ON rh.app_date >= dw.start_date AND rh.app_date < dw.end_date
    GROUP BY rh.rule_name
)
SELECT
    @scenario_id      AS scenario_id,
    @months_back      AS months_back,
    @fraud_cap_amount AS fraud_cap_amount,
    @fpr_threshold    AS fpr_threshold,
    rule_name,
    unique_apps_agg,
    unique_fraud_amt_agg
FROM final_agg;
';


DECLARE 
    @scenario_id INT,
    @months_back INT,
    @fraud_cap_amount DECIMAL(18,2),
    @fpr_threshold FLOAT;

DECLARE scenario_cursor CURSOR FAST_FORWARD FOR
SELECT scenario_id, months_back, fraud_cap_amount, fpr_threshold
FROM #Scenarios;

OPEN scenario_cursor;
FETCH NEXT FROM scenario_cursor INTO @scenario_id, @months_back, @fraud_cap_amount, @fpr_threshold;

WHILE @@FETCH_STATUS = 0
BEGIN
    INSERT INTO #ScenarioResults (
        scenario_id,
        months_back,
        fraud_cap_amount,
        fpr_threshold,
        rule_name,
        unique_apps_agg,
        unique_fraud_amt_agg
    )
    EXEC sp_executesql
        @sql,
        N'@scenario_id INT,
          @months_back INT,
          @fraud_cap_amount DECIMAL(18,2),
          @fpr_threshold FLOAT',
        @scenario_id      = @scenario_id,
        @months_back      = @months_back,
        @fraud_cap_amount = @fraud_cap_amount,
        @fpr_threshold    = @fpr_threshold;

    FETCH NEXT FROM scenario_cursor INTO @scenario_id, @months_back, @fraud_cap_amount, @fpr_threshold;
END

CLOSE scenario_cursor;
DEALLOCATE scenario_cursor;


SELECT * 
FROM #ScenarioResults
ORDER BY rule_name, months_back, fraud_cap_amount, fpr_threshold;


SELECT
    rule_name,
    COUNT(*) AS times_flagged,
    MIN(months_back) AS min_months_back,
    MIN(fraud_cap_amount) AS min_cap,
    MAX(fpr_threshold) AS max_fpr_used
FROM #ScenarioResults
GROUP BY rule_name
ORDER BY times_flagged DESC;
